function showPreview(){const e=document.querySelector('[name="question"]').value,t=document.querySelector('[name="topic"]').value,n=document.querySelector('[name="difficulty"]').value,a=document.querySelector('[name="grade"]').value,r=document.querySelectorAll("#answers-container .card"),d=document.getElementById("preview-answers")
d.innerHTML="",r.forEach(((e,t)=>{const n=e.querySelector('textarea[name^="answers["]').value,a=e.querySelector('textarea[name$=".explanation"]').value,r=`\n      <div class="answer-btn" data-correct="${"true"===e.querySelector('input[name$=".isCorrect"]').value}">\n        <span>${n}</span>\n        ${a?`<span class="text-muted ms-2">${a}</span>`:""}\n      </div>`
d.insertAdjacentHTML("beforeend",r)})),document.getElementById("preview-question").innerHTML=e,document.getElementById("preview-topic").textContent=t,document.getElementById("preview-difficulty").textContent=n,document.getElementById("preview-grade").textContent=a,new bootstrap.Modal(document.getElementById("previewModal")).show()}function showEditPreview(){const e=document.getElementById("editQuestionModal"),t=document.getElementById("previewModal"),n=bootstrap.Modal.getInstance(e)
n&&n.hide()
const a=document.getElementById("editQuestion").value,r=document.getElementById("editTopic").options[document.getElementById("editTopic").selectedIndex].text,d=document.getElementById("editDifficulty").options[document.getElementById("editDifficulty").selectedIndex].text,o=document.getElementById("editGrade").options[document.getElementById("editGrade").selectedIndex].text
document.getElementById("preview-question").innerHTML=a
const s=document.querySelectorAll("#editAnswersContainer .card"),c=document.getElementById("preview-answers")
c.innerHTML="",s.forEach(((e,t)=>{const n=e.querySelector('textarea[name^="answers["]').value,a=e.querySelector('textarea[name$=".explanation"]').value,r=`\n      <div class="answer-btn" data-correct="${"true"===e.querySelector('input[name$=".isCorrect"]').value}">\n        <span>${n}</span>\n        ${a?`<span class="text-muted ms-2">${a}</span>`:""}\n      </div>`
c.insertAdjacentHTML("beforeend",r)})),document.getElementById("preview-topic").textContent=r,document.getElementById("preview-difficulty").textContent=d,document.getElementById("preview-grade").textContent=o,new bootstrap.Modal(t).show(),t.addEventListener("hidden.bs.modal",(function e(){n.show(),t.removeEventListener("hidden.bs.modal",e)}))}document.addEventListener("DOMContentLoaded",(function(){function e(){const e=document.getElementById("answers-container"),t=e.querySelectorAll(".card"),n=e.querySelector('input[type="radio"]:checked')
if(n){const e=parseInt(n.value)
t.forEach(((t,n)=>{t.querySelector('input[name$=".isCorrect"]').value=n===e?"true":"false"}))}}function t(e){fetch(`/admin/questions/${e}/data`).then((e=>e.json())).then((e=>{document.getElementById("editTaskId").value=e.id,document.getElementById("editQuestion").value=e.question,document.getElementById("editTopic").value=e.topic,document.getElementById("editDifficulty").value=e.difficulty,document.getElementById("editGrade").value=e.grade
const t=document.getElementById("editAnswersContainer")
t.innerHTML="",e.answers.forEach(((e,r)=>{const d=document.createElement("div")
d.className="card mb-3",d.innerHTML=`\n            <div class="card-body">\n              <div class="d-flex justify-content-between mb-3">\n                <div class="form-check">\n                  <input class="form-check-input" type="radio" name="editCorrectAnswer" value="${r}" ${e.isCorrect?"checked":""}>\n                  <label class="form-check-label">Правильный ответ</label>\n                </div>\n                <button type="button" class="btn btn-sm btn-outline-danger edit-remove-answer">\n                  <i class="fa-solid fa-times"></i> Удалить\n                </button>\n              </div>\n              <div class="mb-3">\n                <label class="form-label">Текст ответа <span class="text-danger">*</span></label>\n                <textarea class="form-control" name="answers[${r}].content" rows="2" required>${e.content}</textarea>\n              </div>\n              <div class="mb-3">\n                <label class="form-label">Пояснение</label>\n                <textarea class="form-control" name="answers[${r}].explanation" rows="2">${e.explanation||""}</textarea>\n              </div>\n              <input type="hidden" name="answers[${r}].isCorrect" value="${e.isCorrect}">\n            </div>\n          `,t.appendChild(d),d.querySelector(".edit-remove-answer").addEventListener("click",(function(){d.remove(),n()})),d.querySelector('input[type="radio"]').addEventListener("change",(function(){a()}))}))
const r=document.getElementById("editQuestionModal")
let d=bootstrap.Modal.getInstance(r)
d||(d=new bootstrap.Modal(r)),d.show()})).catch((e=>{}))}function n(){document.getElementById("editAnswersContainer").querySelectorAll(".card").forEach(((e,t)=>{const n=e.querySelector('textarea[name^="answers["]'),a=e.querySelector('textarea[name$=".explanation"]'),r=e.querySelector('input[name$=".isCorrect"]'),d=e.querySelector('input[type="radio"]')
n.name=`answers[${t}].content`,a.name=`answers[${t}].explanation`,r.name=`answers[${t}].isCorrect`,d.value=t}))}function a(){const e=document.getElementById("editAnswersContainer"),t=e.querySelectorAll(".card"),n=e.querySelector('input[type="radio"]:checked')
if(n){const e=parseInt(n.value)
t.forEach(((t,n)=>{t.querySelector('input[name$=".isCorrect"]').value=n===e?"true":"false"}))}}function r(){const e=new URLSearchParams({topic:s.value,difficulty:c.value,grade:l.value,search:i.value})
fetch(`${o}?${e.toString()}`).then((e=>e.text())).then((e=>{m.innerHTML=e,d()}))}function d(){document.querySelectorAll(".edit-task-btn").forEach((e=>{e.addEventListener("click",(function(){t(this.getAttribute("data-id"))}))}))}const o="/admin/filter/questions"
if(document.querySelectorAll(".edit-task-btn").forEach((e=>{e.addEventListener("click",(function(){t(this.getAttribute("data-id"))}))})),!document.getElementById("previewModal")){const e=document.createElement("div")
e.className="modal fade",e.id="previewModal",e.tabIndex="-1",e.setAttribute("aria-labelledby","previewModalLabel"),e.setAttribute("aria-hidden","true"),e.innerHTML='\n      <div class="modal-dialog modal-lg">\n        <div class="modal-content">\n          <div class="modal-header">\n            <h5 class="modal-title" id="previewModalLabel">Предпросмотр вопроса</h5>\n            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>\n          </div>\n          <div class="modal-body">\n            <div class="card mb-3">\n              <div class="card-header">\n                <div class="d-flex justify-content-between align-items-center">\n                  <h5 id="preview-topic" class="mb-0"></h5>\n                  <div>\n                    <span class="badge bg-primary me-2" id="preview-difficulty"></span>\n                    <span class="badge bg-secondary" id="preview-grade"></span>\n                  </div>\n                </div>\n              </div>\n              <div class="card-body">\n                <p id="preview-question"></p>\n                <hr>\n                <h6>Ответы:</h6>\n                <ul class="list-group" id="preview-answers"></ul>\n              </div>\n            </div>\n          </div>\n          <div class="modal-footer">\n            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>\n          </div>\n        </div>\n      </div>\n    ',document.body.appendChild(e)}document.getElementById("addAnswerBtn").addEventListener("click",(function(){const t=document.getElementById("answers-container"),n=t.querySelectorAll(".card").length,a=document.createElement("div")
a.className="card mb-3",a.innerHTML=`\n      <div class="card-body">\n        <div class="d-flex justify-content-between mb-3">\n          <div class="form-check">\n            <input class="form-check-input" type="radio" name="correctAnswer" value="${n}">\n            <label class="form-check-label">Правильный ответ</label>\n          </div>\n          <button type="button" class="btn btn-sm btn-outline-danger remove-answer">\n            <i class="fa-solid fa-times"></i> Удалить\n          </button>\n        </div>\n        <div class="mb-3">\n          <label class="form-label">Текст ответа <span class="text-danger">*</span></label>\n          <textarea class="form-control" name="answers[${n}].content" rows="2" required></textarea>\n        </div>\n        <div class="mb-3">\n          <label class="form-label">Пояснение</label>\n          <textarea class="form-control" name="answers[${n}].explanation" rows="2"></textarea>\n        </div>\n        <input type="hidden" name="answers[${n}].isCorrect" value="false">\n      </div>\n    `,t.appendChild(a),a.querySelector(".remove-answer").addEventListener("click",(function(){a.remove(),document.getElementById("answers-container").querySelectorAll(".card").forEach(((e,t)=>{const n=e.querySelector('textarea[name^="answers["]'),a=e.querySelector('textarea[name$=".explanation"]'),r=e.querySelector('input[name$=".isCorrect"]'),d=e.querySelector('input[type="radio"]')
n.name=`answers[${t}].content`,a.name=`answers[${t}].explanation`,r.name=`answers[${t}].isCorrect`,d.value=t}))})),a.querySelector('input[type="radio"]').addEventListener("change",(function(){e()}))})),document.querySelectorAll('#answers-container input[type="radio"][name="correctAnswer"]').forEach((t=>{t.addEventListener("change",(function(){e()}))})),document.getElementById("saveEditBtn").addEventListener("click",(function(e){e.preventDefault()
const t=document.getElementById("editTaskId").value,n=new FormData(document.getElementById("editTaskForm")),a={}
n.forEach(((e,t)=>{if(t.includes(".")){const n=t.split("."),r=n[0].split("[")[0],d=parseInt(n[0].match(/\d+/)[0]),o=n[1]
a[r]||(a[r]=[]),a[r][d]||(a[r][d]={}),a[r][d][o]="true"===e||"false"!==e&&e}else a[t]=e}))
const r=document.querySelector('meta[name="_csrf"]').getAttribute("content"),d=document.querySelector('meta[name="_csrf_header"]').getAttribute("content")
fetch(`/admin/questions/${t}`,{method:"PUT",headers:{"Content-Type":"application/json",[d]:r},body:JSON.stringify(a)}).then((e=>{if(!e.ok)throw new Error("Ошибка при обновлении вопроса")
window.location.href="/admin/questions"})).catch((e=>{alert("Произошла ошибка при обновлении вопроса")}))})),document.getElementById("editAddAnswerBtn").addEventListener("click",(function(){const e=document.getElementById("editAnswersContainer"),t=e.querySelectorAll(".card").length,r=document.createElement("div")
r.className="card mb-3",r.innerHTML=`\n      <div class="card-body">\n        <div class="d-flex justify-content-between mb-3">\n          <div class="form-check">\n            <input class="form-check-input" type="radio" name="editCorrectAnswer" value="${t}">\n            <label class="form-check-label">Правильный ответ</label>\n          </div>\n          <button type="button" class="btn btn-sm btn-outline-danger edit-remove-answer">\n            <i class="fa-solid fa-times"></i> Удалить\n          </button>\n        </div>\n        <div class="mb-3">\n          <label class="form-label">Текст ответа <span class="text-danger">*</span></label>\n          <textarea class="form-control" name="answers[${t}].content" rows="2" required></textarea>\n        </div>\n        <div class="mb-3">\n          <label class="form-label">Пояснение</label>\n          <textarea class="form-control" name="answers[${t}].explanation" rows="2"></textarea>\n        </div>\n        <input type="hidden" name="answers[${t}].isCorrect" value="false">\n      </div>\n    `,e.appendChild(r),r.querySelector(".edit-remove-answer").addEventListener("click",(function(){r.remove(),n()})),r.querySelector('input[type="radio"]').addEventListener("change",(function(){a()}))}))
const s=document.getElementById("topicFilter"),c=document.getElementById("difficultyFilter"),l=document.getElementById("gradeFilter"),i=document.getElementById("searchInput"),u=document.getElementById("resetFilters"),m=document.getElementById("tasksTableBody")
d(),s.addEventListener("change",r),c.addEventListener("change",r),l.addEventListener("change",r),i.addEventListener("input",(function(){r()})),u.addEventListener("click",(function(){s.value="",c.value="",l.value="",i.value="",r()}))}))
